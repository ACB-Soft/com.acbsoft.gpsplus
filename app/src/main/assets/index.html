<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ACB_Soft GPS Plus v4.5.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
          theme: {
            extend: {
              fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
              animation: { 'in': 'fadeIn 0.3s ease-out', 'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite' },
              keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
            }
          }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap');
        :root { --cream-bg: #F1F5F9; --cream-card: #FFFFFF; --accent-blue: #2563eb; }
        body { background-color: var(--cream-bg); font-family: 'Plus Jakarta Sans', sans-serif; overflow: hidden; height: 100vh; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        .soft-card { background: var(--cream-card); border-radius: 2rem; border: 1px solid rgba(0, 0, 0, 0.05); box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.04); }
        .mono-font { font-family: 'JetBrains Mono', monospace; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .scanner-line { height: 3px; background: linear-gradient(to right, transparent, var(--accent-blue), transparent); position: absolute; width: 100%; animation: scan-light 2.5s infinite linear; z-index: 5; box-shadow: 0 0 10px var(--accent-blue); }
        @keyframes scan-light { 0% { top: 0; } 50% { top: 100%; } 100% { top: 0; } }
        #root { height: 100%; display: flex; flex-direction: column; position: relative; }
        .animate-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        select { -webkit-appearance: none; appearance: none; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.4",
    "react/": "https://esm.sh/react@^19.2.4/",
    "react-leaflet": "https://esm.sh/react-leaflet@^5.0.0",
    "leaflet": "https://esm.sh/leaflet@^1.9.4",
    "xlsx": "https://esm.sh/xlsx@^0.18.5",
    "jszip": "https://esm.sh/jszip@^3.10.1"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div id="root"></div>

    <script>
        /**
         * ACB_Soft GPS Plus v4.5.0 - WebView Turbo Core
         * Pure Vanilla JS implementation for maximum efficiency in single file
         */

        // --- GLOBAL STATE ---
        const STATE = {
            view: localStorage.getItem('onboarding_v4_done') ? 'home' : 'onboarding',
            savedLocations: JSON.parse(localStorage.getItem('gps_locations_v4') || '[]'),
            currentCapture: {
                step: 'SELECT_MODE', // SELECT_MODE, FORM, READY, COUNTDOWN
                folderName: localStorage.getItem('last_folder_name') || '',
                pointName: '',
                isNewProject: true,
                seconds: 5,
                samples: [],
                instantAccuracy: null
            },
            lastResult: null,
            expandedFolders: [],
            selectedExportFolders: []
        };

        const BRAND = { full: "ACB_Soft GPS Plus v4.5.0" };

        // --- GEOID (EGM96) ENGINE ---
        const EGM96_GRID = [[13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13],[3,1,-2,-3,-3,-3,-1,3,1,5,9,11,19,27,31,34,33,34,33,34,28,23,17,13,11,4,1,1,2,2,3,2,1,1,1,1,3],[-13,-15,-18,-14,-11,-7,-2,1,-9,-1,1,11,21,21,23,26,31,35,39,45,45,45,39,34,21,18,15,14,8,5,1,-3,-7,-10,-11,-12,-13],[-21,-27,-23,-14,-2,7,13,18,19,20,19,13,11,13,15,14,15,20,31,42,53,59,61,62,53,39,28,14,2,-5,-15,-23,-27,-26,-24,-22,-21],[-21,-25,-26,-15,4,16,21,23,25,25,19,7,-3,-10,-16,-20,-18,-12,0,15,30,43,57,60,50,42,29,21,10,-3,-13,-20,-23,-24,-23,-22,-21],[-16,-18,-19,-15,-4,11,19,23,23,21,13,2,-12,-26,-33,-34,-31,-21,-5,14,28,33,35,34,31,25,19,16,11,-1,-11,-18,-20,-20,-19,-17,-16],[4,1,-5,-11,-12,2,14,21,25,23,11,1,-13,-29,-38,-42,-43,-37,-19,2,16,17,15,12,11,14,16,18,13,6,-3,-11,-13,-11,-5,1,4],[13,11,7,1,-5,-3,8,15,22,21,13,1,-15,-31,-43,-51,-56,-55,-43,-21,-1,3,5,5,7,11,13,15,15,11,5,-2,-7,-6,-2,6,13],[15,13,10,7,5,8,12,16,21,23,17,3,-14,-30,-42,-52,-58,-62,-53,-34,-15,-6,-3,-1,3,7,10,13,15,14,11,6,2,3,5,10,15],[16,15,14,14,16,21,24,26,29,29,22,11,-4,-20,-31,-40,-47,-53,-47,-33,-16,-8,-5,-2,2,6,9,13,15,16,15,13,11,12,13,14,16],[13,15,17,21,24,29,32,34,34,32,26,18,8,-5,-15,-24,-31,-34,-31,-23,-11,-4,-1,1,4,8,10,13,15,16,16,15,14,13,13,13,13],[1,5,11,17,23,29,34,38,38,34,28,22,15,6,-1,-9,-15,-18,-17,-13,-7,-2,0,2,5,9,11,12,12,11,9,7,4,3,1,1,1],[-16,-11,-6,2,11,19,25,29,31,31,28,25,21,16,10,4,1,-1,-1,-1,0,1,3,5,8,11,12,11,8,4,1,-4,-8,-12,-15,-17,-16],[-29,-25,-19,-11,-2,8,16,22,25,27,28,28,28,26,22,17,13,11,11,11,12,12,13,15,17,18,17,13,7,1,-6,-14,-21,-26,-29,-30,-29],[-30,-31,-29,-23,-15,-6,2,10,15,19,23,26,28,28,26,24,22,21,21,23,24,24,25,26,26,24,19,11,1,-8,-17,-25,-30,-32,-32,-31,-30],[-21,-24,-28,-28,-25,-19,-12,-5,1,7,13,18,22,24,24,23,23,24,26,28,28,28,27,26,22,17,8,-1,-11,-20,-25,-28,-27,-26,-24,-22,-21],[-11,-15,-20,-25,-26,-26,-21,-15,-8,-1,4,10,15,19,21,22,23,24,27,29,29,28,25,21,13,4,-5,-13,-19,-21,-19,-15,-13,-11,-11,-10,-11],[-13,-14,-16,-19,-22,-25,-26,-24,-21,-16,-11,-5,-1,4,7,10,13,16,19,21,22,21,18,13,7,1,-5,-10,-13,-13,-12,-11,-11,-11,-11,-12,-13],[-29,-29,-29,-29,-29,-29,-29,-29,-29,-29,-29,-29,-29,-29,-29,-29,-29,-29,-29,-29,-29,-29,-29,-29,-29,-29,-29,-29,-29,-29,-29,-29,-29,-29,-29,-29,-29]];

        function getGeoidUndulation(lat, lng) {
            let lon = ((lng + 180) % 360);
            if (lon < 0) lon += 360;
            lon -= 180;
            const row = (90 - lat) / 10;
            const col = (lon + 180) / 10;
            const r0 = Math.floor(row), r1 = Math.min(r0 + 1, 18);
            const c0 = Math.floor(col), c1 = (c0 + 1) % 36;
            const dr = row - r0, dc = col - c0;
            const n00 = EGM96_GRID[r0][c0], n01 = EGM96_GRID[r0][c1], n10 = EGM96_GRID[r1][c0], n11 = EGM96_GRID[r1][c1];
            return (1 - dr) * (1 - dc) * n00 + (1 - dr) * dc * n01 + dr * (1 - dc) * n10 + dr * dc * n11;
        }

        // --- GPS ENGINE ---
        let watchId = null;
        let timerId = null;

        function startGPS() {
            if (watchId) return;
            if ("geolocation" in navigator) {
                watchId = navigator.geolocation.watchPosition(
                    (pos) => {
                        STATE.currentCapture.instantAccuracy = pos.coords.accuracy;
                        if (STATE.currentCapture.step === 'COUNTDOWN') {
                            const undulation = getGeoidUndulation(pos.coords.latitude, pos.coords.longitude);
                            const msl = pos.coords.altitude !== null ? pos.coords.altitude - undulation : null;
                            STATE.currentCapture.samples.push({
                                lat: pos.coords.latitude, lng: pos.coords.longitude,
                                accuracy: pos.coords.accuracy, altitude: msl, timestamp: Date.now()
                            });
                        }
                        render();
                    },
                    (err) => { console.warn("GPS Hatası:", err); STATE.currentCapture.instantAccuracy = null; render(); },
                    { enableHighAccuracy: true, maximumAge: 0, timeout: 15000 }
                );
            }
        }

        function stopGPS() {
            if (watchId) { navigator.geolocation.clearWatch(watchId); watchId = null; }
        }

        // --- ROUTING & RENDERING ---
        const root = document.getElementById('root');

        function navigate(view) {
            STATE.view = view;
            if (view === 'capture') {
                STATE.currentCapture.step = 'SELECT_MODE';
                STATE.currentCapture.samples = [];
                startGPS();
            }
            render();
        }

        function render() {
            root.innerHTML = '';
            let content = '';
            switch(STATE.view) {
                case 'onboarding': content = viewOnboarding(); break;
                case 'home': content = viewHome(); break;
                case 'capture': content = viewCapture(); break;
                case 'result': content = viewResult(); break;
                case 'list': content = viewList(); break;
                case 'export': content = viewExport(); break;
            }
            root.innerHTML = content;
            attachEvents();
        }

        // --- VIEW TEMPLATES ---
        function viewOnboarding() {
            return `
            <div class="h-full flex flex-col items-center p-6 bg-slate-100 animate-in text-center">
                <div class="flex-1 flex flex-col items-center justify-center space-y-4 max-w-sm">
                    <div class="w-16 h-16 bg-[#2563eb] rounded-3xl flex items-center justify-center shadow-2xl mb-4">
                        <i class="fas fa-shield-halved text-white text-2xl"></i>
                    </div>
                    <h1 class="text-xl font-black text-slate-800 tracking-tight">Cihaz İzinleri ve Kurulum</h1>
                    <p class="text-[13px] text-slate-500 font-bold px-4 leading-snug">Mobil Cihazlarınız için Konum Belirleme Uygulaması: <span class="text-[#2563eb] font-black">GPS Plus</span></p>
                    <div class="space-y-3 text-left w-full pt-6">
                        <div class="flex gap-4 items-center bg-white p-4 rounded-3xl border border-slate-200/50 shadow-sm">
                            <div class="w-10 h-10 rounded-2xl bg-blue-50 flex items-center justify-center text-[#2563eb] shrink-0"><i class="fas fa-location-dot"></i></div>
                            <p class="text-[11px] font-bold text-slate-600">GPS verisi için tam konum izni gereklidir.</p>
                        </div>
                        <div class="flex gap-4 items-center bg-white p-4 rounded-3xl border border-slate-200/50 shadow-sm">
                            <div class="w-10 h-10 rounded-2xl bg-blue-50 flex items-center justify-center text-[#2563eb] shrink-0"><i class="fas fa-camera"></i></div>
                            <p class="text-[11px] font-bold text-slate-600">Saha fotoğrafı için kamera erişimi gereklidir.</p>
                        </div>
                    </div>
                    <button id="btn-onboarding" class="w-full py-5 bg-[#2563eb] text-white rounded-[1.8rem] font-black uppercase tracking-widest shadow-xl shadow-blue-100 mt-8 active:scale-95 transition-all">İzinleri Onayla ve Başla</button>
                </div>
            </div>`;
        }

        function viewHome() {
            return `
            <div class="h-full flex flex-col bg-[#F1F5F9] animate-in">
                <header class="w-full px-8 pt-12 pb-8 flex items-center gap-6 shrink-0">
                    <div class="w-20 h-20 bg-[#2563eb] rounded-3xl flex items-center justify-center shadow-lg shadow-blue-100 shrink-0">
                        <i class="fas fa-location-dot text-white text-4xl"></i>
                    </div>
                    <div class="flex flex-col">
                        <h1 class="text-sm font-bold tracking-wide text-slate-500 leading-tight">Konum Belirleme:<br/><span class="text-[#2563eb] text-xl font-black">GPS Plus</span></h1>
                        <div class="w-12 h-1.5 bg-blue-100 rounded-full mt-2"></div>
                    </div>
                </header>
                <main class="px-6 space-y-4">
                    <button id="btn-go-capture" class="w-full p-8 rounded-[2.5rem] bg-[#2563eb] shadow-xl shadow-blue-100 text-left flex flex-col gap-2 group active:scale-[0.98] transition-all">
                        <div class="w-12 h-12 rounded-2xl bg-white/20 flex items-center justify-center text-white mb-1"><i class="fas fa-plus"></i></div>
                        <span class="text-xl font-black text-white leading-tight">Yeni Ölçüm Yap ve<br/>Projeye Kaydet</span>
                    </button>
                    <div class="grid grid-cols-2 gap-4">
                        <button id="btn-go-list" class="p-8 rounded-[2.5rem] bg-white border border-slate-100 shadow-xl text-left active:scale-[0.98] transition-all">
                            <div class="w-10 h-10 rounded-xl bg-blue-50 flex items-center justify-center text-[#2563eb] mb-2"><i class="fas fa-folder-tree"></i></div>
                            <span class="text-sm font-black text-slate-800 uppercase tracking-tight">Kayıtlı Projeler</span>
                        </button>
                        <button id="btn-go-export" class="p-8 rounded-[2.5rem] bg-white border border-slate-100 shadow-xl text-left active:scale-[0.98] transition-all">
                            <div class="w-10 h-10 rounded-xl bg-slate-50 flex items-center justify-center text-emerald-600 mb-2"><i class="fas fa-file-export"></i></div>
                            <span class="text-sm font-black text-slate-800 uppercase tracking-tight">Veri Aktarımı</span>
                        </button>
                    </div>
                </main>
                <footer class="mt-auto py-6 opacity-40 text-center">
                    <span class="text-[10px] font-bold uppercase tracking-[0.3em] text-slate-400">${BRAND.full}</span>
                </footer>
            </div>`;
        }

        function viewCapture() {
            const c = STATE.currentCapture;
            const header = (title, backId) => `
                <div class="relative flex items-center justify-center sticky top-0 bg-[#F1F5F9]/90 backdrop-blur-md z-20 pt-12 pb-6 px-6 w-full shrink-0">
                    <button id="${backId}" class="absolute left-6 bottom-4 w-12 h-12 flex items-center justify-center rounded-2xl bg-white shadow-sm border border-slate-100 text-slate-600 active:scale-90 transition-all"><i class="fas fa-chevron-left"></i></button>
                    <h2 class="text-xl font-extrabold text-slate-800">${title}</h2>
                </div>`;

            if (c.step === 'SELECT_MODE') {
                return `
                <div class="h-full flex flex-col items-center bg-[#F1F5F9] animate-in">
                    ${header("Yeni Ölçüm", "btn-back-home")}
                    <div class="w-full max-w-[340px] px-4 space-y-4 pt-6">
                        <button id="btn-mode-new" class="w-full p-8 rounded-[2rem] bg-white border border-slate-100 shadow-xl text-left flex flex-col gap-2 group active:scale-95 transition-all">
                            <div class="w-10 h-10 rounded-xl bg-blue-50 text-[#2563eb] flex items-center justify-center mb-2"><i class="fas fa-folder-plus"></i></div>
                            <span class="text-base font-black text-slate-800">Yeni Proje Oluştur</span>
                        </button>
                        <button id="btn-mode-existing" class="w-full p-8 rounded-[2rem] bg-white border border-slate-100 shadow-xl text-left flex flex-col gap-2 group active:scale-95 transition-all">
                            <div class="w-10 h-10 rounded-xl bg-emerald-50 text-emerald-600 flex items-center justify-center mb-2"><i class="fas fa-folder-open"></i></div>
                            <span class="text-base font-black text-slate-800">Mevcut Projeye Devam</span>
                        </button>
                    </div>
                </div>`;
            }

            if (c.step === 'FORM') {
                const folders = Array.from(new Set(STATE.savedLocations.map(l => l.folderName)));
                return `
                <div class="h-full flex flex-col items-center bg-[#F1F5F9] animate-in">
                    ${header("Proje Bilgisi", "btn-back-mode")}
                    <div class="w-full max-w-[340px] px-4 pt-6">
                        <div class="soft-card p-6 space-y-6">
                            ${!c.isNewProject ? `
                                <div>
                                    <label class="block text-[9px] uppercase text-slate-400 font-black mb-1.5 px-2">Proje Seçin</label>
                                    <select id="select-folder" class="w-full bg-blue-50/50 border border-blue-100 rounded-2xl p-4 text-slate-800 font-bold outline-none">
                                        <option value="">Seçiniz...</option>
                                        ${folders.map(f => `<option value="${f}" ${c.folderName === f ? 'selected' : ''}>${f}</option>`).join('')}
                                    </select>
                                </div>` : `
                                <div>
                                    <label class="block text-[9px] uppercase text-slate-400 font-black mb-1.5 px-2">Yeni Proje Adı</label>
                                    <input type="text" id="input-folder" value="${c.folderName}" placeholder="Örn: Proje A" class="w-full bg-slate-50 border border-slate-100 rounded-2xl p-4 text-slate-800 font-bold outline-none">
                                </div>`}
                            <button id="btn-proceed-ready" class="w-full py-5 bg-[#2563eb] text-white rounded-2xl font-bold active:scale-95 shadow-lg shadow-blue-50 transition-all">İleri</button>
                        </div>
                    </div>
                </div>`;
            }

            return `
            <div class="h-full flex flex-col items-center bg-[#F1F5F9] animate-in">
                ${header("Ölçüm Ekranı", "btn-back-form")}
                <div class="flex-1 flex flex-col items-center justify-center space-y-8 w-full max-w-[340px] px-4">
                    <h3 class="text-xl font-extrabold text-[#2563eb] truncate px-4">${c.folderName}</h3>
                    <div class="relative w-56 h-56 flex items-center justify-center">
                        <div class="absolute inset-0 border-2 rounded-full border-slate-100"></div>
                        ${c.step === 'COUNTDOWN' ? `<div class="scanner-line"></div>` : ''}
                        <div class="text-8xl font-black text-slate-800 mono-font">
                            ${c.step === 'COUNTDOWN' ? c.seconds : `<i class="fas fa-location-crosshairs text-6xl text-slate-200"></i>`}
                        </div>
                    </div>
                    ${c.step === 'READY' ? `
                    <div class="w-full space-y-4">
                        <div class="bg-white p-6 rounded-3xl border border-slate-100 space-y-4 shadow-sm">
                            <label class="block text-[9px] uppercase text-slate-400 font-black">Nokta İsmi</label>
                            <input type="text" id="input-point" value="${c.pointName}" class="w-full bg-slate-50 border border-slate-100 rounded-2xl p-4 text-slate-800 font-black text-center text-lg outline-none">
                            <div class="flex items-center justify-between bg-slate-50 p-3 rounded-xl border border-slate-100">
                                <span class="text-[10px] font-bold text-slate-500 uppercase">Sinyal</span>
                                <span class="text-xs font-bold mono-font ${c.instantAccuracy ? 'text-emerald-600' : 'text-slate-400'}">
                                    ${c.instantAccuracy ? `±${c.instantAccuracy.toFixed(1)}m` : 'Aranıyor...'}
                                </span>
                            </div>
                            <button id="btn-start-countdown" class="w-full py-6 bg-emerald-600 text-white rounded-[1.5rem] font-black text-xl flex items-center justify-center gap-3 active:scale-95 transition-all shadow-lg shadow-emerald-100"><i class="fas fa-play"></i>BAŞLA</button>
                        </div>
                    </div>` : `
                    <div class="text-center space-y-4 w-full">
                        <p class="text-slate-500 text-sm font-medium">Hassas ölçüm yapılıyor...</p>
                        <div class="text-xs font-black text-emerald-600 uppercase tracking-widest">${c.samples.length} Veri Alındı</div>
                        <button id="btn-cancel-countdown" class="px-12 py-4 rounded-2xl bg-slate-100 text-slate-500 font-bold text-xs uppercase">Durdur</button>
                    </div>`}
                </div>
            </div>`;
        }

        function viewResult() {
            const loc = STATE.lastResult;
            if (!loc) return '';
            return `
            <div class="h-full flex flex-col bg-[#F1F5F9] animate-in items-center">
                <div class="pt-12 pb-6 px-6 w-full text-center shrink-0"><h2 class="text-xl font-extrabold text-slate-800">Ölçüm Özeti</h2></div>
                <div class="flex-1 w-full max-w-[340px] px-4 space-y-6 pb-12 overflow-y-auto no-scrollbar">
                    <div class="soft-card p-6 space-y-6 text-center">
                        ${loc.photo ? `<img src="${loc.photo}" class="w-full h-40 object-cover rounded-2xl shadow-inner border">` : `
                        <div id="btn-add-photo" class="w-full py-10 bg-slate-50 border-2 border-dashed rounded-2xl flex flex-col items-center justify-center gap-3 cursor-pointer">
                            <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center text-slate-300 shadow-sm"><i class="fas fa-camera"></i></div>
                            <span class="text-[10px] font-black text-blue-600 uppercase">Fotoğraf Ekle</span>
                        </div>`}
                        <div class="grid grid-cols-2 gap-3 text-left">
                            <div class="bg-slate-50 p-3 rounded-xl border"><div class="text-[8px] text-slate-400 font-black uppercase mb-1">Enlem</div><div class="text-xs font-bold mono-font truncate">${loc.lat.toFixed(7)}</div></div>
                            <div class="bg-slate-50 p-3 rounded-xl border"><div class="text-[8px] text-slate-400 font-black uppercase mb-1">Boylam</div><div class="text-xs font-bold mono-font truncate">${loc.lng.toFixed(7)}</div></div>
                            <div class="bg-slate-50 p-3 rounded-xl border"><div class="text-[8px] text-slate-400 font-black uppercase mb-1">Yükseklik</div><div class="text-xs font-bold mono-font text-blue-600">${loc.altitude ? Math.round(loc.altitude) + 'm' : '---'}</div></div>
                            <div class="bg-slate-50 p-3 rounded-xl border"><div class="text-[8px] text-emerald-600 font-black uppercase mb-1">Hassasiyet</div><div class="text-xs font-bold mono-font text-slate-800">±${loc.accuracy.toFixed(1)}m</div></div>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <button id="btn-continue" class="w-full py-5 bg-[#2563eb] text-white rounded-[1.5rem] font-bold shadow-xl active:scale-95 transition-all">Devam Et</button>
                        <button id="btn-finish" class="w-full py-4 bg-slate-900 text-white rounded-[1.5rem] font-bold opacity-80 active:scale-95 transition-all">Bitir</button>
                    </div>
                </div>
            </div>`;
        }

        function viewList() {
            const folders = {};
            STATE.savedLocations.forEach(l => { if (!folders[l.folderName]) folders[l.folderName] = []; folders[l.folderName].push(l); });
            return `
            <div class="h-full flex flex-col bg-[#F1F5F9] animate-in items-center">
                <div class="relative flex items-center justify-center sticky top-0 bg-[#F1F5F9]/90 pt-12 pb-6 px-6 w-full shrink-0">
                    <button id="btn-list-back" class="absolute left-6 bottom-4 w-12 h-12 flex items-center justify-center rounded-2xl bg-white shadow-sm border border-slate-100 text-slate-600 active:scale-90 transition-all"><i class="fas fa-chevron-left"></i></button>
                    <h2 class="text-xl font-extrabold text-slate-800">Kayıtlı Projeler</h2>
                </div>
                <div class="flex-1 w-full max-w-[400px] px-6 py-4 space-y-4 overflow-y-auto no-scrollbar pb-24">
                    ${Object.keys(folders).length === 0 ? `<p class="py-20 text-center opacity-30 text-xs font-black uppercase">Kayıt Yok</p>` : Object.entries(folders).map(([name, locs]) => `
                    <div class="soft-card overflow-hidden">
                        <div onclick="toggleFolderExpanded('${name}')" class="p-5 flex items-center justify-between cursor-pointer active:bg-slate-50">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 bg-blue-50 text-blue-500 rounded-xl flex items-center justify-center"><i class="fas fa-folder"></i></div>
                                <div><h4 class="font-extrabold text-sm text-slate-800">${name}</h4><p class="text-[9px] font-black text-slate-400 uppercase tracking-widest">${locs.length} Nokta</p></div>
                            </div>
                            <div class="flex gap-4">
                                <button onclick="deleteProject('${name}')" class="text-slate-300 p-2"><i class="fas fa-trash text-[10px]"></i></button>
                                <i class="fas fa-chevron-down text-[10px] text-slate-300 ${STATE.expandedFolders.includes(name) ? 'rotate-180' : ''}"></i>
                            </div>
                        </div>
                        ${STATE.expandedFolders.includes(name) ? `
                        <div class="p-3 bg-slate-50/50 space-y-2">
                            ${locs.map(l => `<div class="bg-white p-3 rounded-2xl border flex items-center gap-3">
                                <div class="w-10 h-10 bg-slate-100 rounded-xl overflow-hidden shrink-0">
                                    ${l.photo ? `<img src="${l.photo}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-slate-300"><i class="fas fa-camera text-xs"></i></div>`}
                                </div>
                                <div class="flex-1 min-w-0"><h5 class="text-xs font-bold truncate">${l.name}</h5><p class="text-[9px] mono-font text-slate-500">±${l.accuracy.toFixed(1)}m</p></div>
                                <button onclick="deletePoint('${l.id}')" class="text-slate-200 p-2"><i class="fas fa-trash text-[10px]"></i></button>
                            </div>`).join('')}
                        </div>` : ''}
                    </div>`).join('')}
                </div>
            </div>`;
        }

        function viewExport() {
            const uniqueFolders = Array.from(new Set(STATE.savedLocations.map(l => l.folderName)));
            return `
            <div class="h-full flex flex-col bg-[#F1F5F9] animate-in items-center">
                <div class="relative flex items-center justify-center sticky top-0 pt-12 pb-6 px-6 w-full shrink-0">
                    <button id="btn-export-back" class="absolute left-6 bottom-4 w-12 h-12 flex items-center justify-center rounded-2xl bg-white shadow-sm border border-slate-100 text-slate-600 active:scale-90 transition-all"><i class="fas fa-chevron-left"></i></button>
                    <h2 class="text-xl font-extrabold text-slate-800">Veri Aktarımı</h2>
                </div>
                <div class="flex-1 w-full max-w-[400px] px-6 py-4 space-y-8 overflow-y-auto no-scrollbar pb-24">
                    <div class="space-y-3">
                        <h4 class="text-[10px] font-black uppercase tracking-widest text-slate-400 px-2">Proje Seçimi</h4>
                        ${uniqueFolders.map(name => {
                            const isSel = STATE.selectedExportFolders.includes(name);
                            return `<div onclick="toggleExportFolder('${name}')" class="soft-card p-5 flex items-center gap-4 cursor-pointer border-2 transition-all ${isSel ? 'border-blue-500 bg-blue-50/20' : 'border-transparent'}">
                                <div class="w-6 h-6 rounded-lg border-2 flex items-center justify-center ${isSel ? 'bg-blue-600 border-blue-600 text-white' : 'border-slate-200'}">${isSel ? '<i class="fas fa-check text-[10px]"></i>' : ''}</div>
                                <span class="text-sm font-bold text-slate-800">${name}</span>
                            </div>`;
                        }).join('')}
                    </div>
                    <div class="space-y-4 border-t pt-8">
                        <button id="btn-ex-kml" class="w-full p-6 bg-indigo-600 text-white rounded-3xl font-bold text-xs uppercase flex items-center gap-5 active:scale-95 transition-all"><i class="fas fa-earth-europe text-xl"></i><span>Google Earth (.KML)</span></button>
                        <button id="btn-ex-xlsx" class="w-full p-6 bg-emerald-600 text-white rounded-3xl font-bold text-xs uppercase flex items-center gap-5 active:scale-95 transition-all"><i class="fas fa-file-excel text-xl"></i><span>Excel (.XLSX)</span></button>
                        <button id="btn-ex-zip" class="w-full p-6 bg-blue-600 text-white rounded-3xl font-bold text-xs uppercase flex items-center gap-5 active:scale-95 transition-all"><i class="fas fa-file-zipper text-xl"></i><span>Fotoğraf Arşivi (.ZIP)</span></button>
                    </div>
                </div>
            </div>`;
        }

        // --- HANDLERS ---
        function attachEvents() {
            const bind = (id, fn) => { const el = document.getElementById(id); if (el) el.onclick = fn; };
            
            bind('btn-onboarding', () => { localStorage.setItem('onboarding_v4_done', 'true'); navigate('home'); });
            bind('btn-go-capture', () => navigate('capture'));
            bind('btn-go-list', () => navigate('list'));
            bind('btn-go-export', () => navigate('export'));
            bind('btn-back-home', () => { stopGPS(); navigate('home'); });
            bind('btn-list-back', () => navigate('home'));
            bind('btn-export-back', () => navigate('home'));
            
            bind('btn-mode-new', () => { STATE.currentCapture.isNewProject = true; STATE.currentCapture.folderName = ''; STATE.currentCapture.step = 'FORM'; render(); });
            bind('btn-mode-existing', () => { STATE.currentCapture.isNewProject = false; STATE.currentCapture.step = 'FORM'; render(); });
            bind('btn-back-mode', () => { STATE.currentCapture.step = 'SELECT_MODE'; render(); });
            bind('btn-back-form', () => { STATE.currentCapture.step = 'FORM'; render(); });

            const sf = document.getElementById('select-folder'); if (sf) sf.onchange = (e) => STATE.currentCapture.folderName = e.target.value;
            const inf = document.getElementById('input-folder'); if (inf) inf.oninput = (e) => STATE.currentCapture.folderName = e.target.value;
            const inp = document.getElementById('input-point'); if (inp) inp.oninput = (e) => STATE.currentCapture.pointName = e.target.value;

            bind('btn-proceed-ready', () => {
                if (!STATE.currentCapture.folderName.trim()) return alert("Proje ismi boş olamaz.");
                localStorage.setItem('last_folder_name', STATE.currentCapture.folderName);
                const count = STATE.savedLocations.filter(l => l.folderName === STATE.currentCapture.folderName).length;
                STATE.currentCapture.pointName = `Nokta ${count + 1}`;
                STATE.currentCapture.step = 'READY'; render();
            });

            bind('btn-start-countdown', () => {
                STATE.currentCapture.samples = []; STATE.currentCapture.seconds = 5; STATE.currentCapture.step = 'COUNTDOWN'; render();
                timerId = setInterval(() => {
                    STATE.currentCapture.seconds--;
                    if (STATE.currentCapture.seconds <= 0) { clearInterval(timerId); processSamples(); } else render();
                }, 1000);
            });

            bind('btn-cancel-countdown', () => { clearInterval(timerId); STATE.currentCapture.step = 'READY'; render(); });
            bind('btn-add-photo', takePhoto);
            bind('btn-continue', () => navigate('capture'));
            bind('btn-finish', () => navigate('home'));
            
            bind('btn-ex-kml', () => exportData('kml'));
            bind('btn-ex-xlsx', () => exportData('xlsx'));
            bind('btn-ex-zip', () => exportData('zip'));
        }

        function processSamples() {
            const samples = STATE.currentCapture.samples;
            if (samples.length === 0) return alert("GPS verisi alınamadı.");
            let pool = samples.filter(s => s.accuracy <= 25);
            if (pool.length === 0) pool = samples;
            pool.sort((a,b) => a.accuracy - b.accuracy);
            const clean = pool.slice(0, Math.max(1, Math.floor(pool.length * 0.8)));
            const avgLat = clean.reduce((a,b) => a + b.lat, 0) / clean.length;
            const avgLng = clean.reduce((a,b) => a + b.lng, 0) / clean.length;
            const avgAcc = clean.reduce((a,b) => a + b.accuracy, 0) / clean.length;
            const avgAlt = clean.reduce((a,b) => a + (b.altitude || 0), 0) / clean.length;
            const newLoc = { id: Date.now().toString(36), folderName: STATE.currentCapture.folderName, name: STATE.currentCapture.pointName, lat: avgLat, lng: avgLng, accuracy: avgAcc, altitude: avgAlt, photo: null, timestamp: Date.now() };
            STATE.savedLocations.unshift(newLoc); STATE.lastResult = newLoc;
            localStorage.setItem('gps_locations_v4', JSON.stringify(STATE.savedLocations));
            navigate('result'); stopGPS();
        }

        function takePhoto() {
            const input = document.createElement('input'); input.type = 'file'; input.accept = 'image/*'; input.capture = 'environment';
            input.onchange = (e) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (re) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); const max = 800;
                        const scale = Math.min(1, max / img.width); canvas.width = img.width * scale; canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        const data = canvas.toDataURL('image/jpeg', 0.8);
                        STATE.lastResult.photo = data;
                        const idx = STATE.savedLocations.findIndex(l => l.id === STATE.lastResult.id);
                        if (idx !== -1) STATE.savedLocations[idx].photo = data;
                        localStorage.setItem('gps_locations_v4', JSON.stringify(STATE.savedLocations)); render();
                    };
                    img.src = re.target.result;
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }

        window.toggleFolderExpanded = (name) => {
            if (STATE.expandedFolders.includes(name)) STATE.expandedFolders = STATE.expandedFolders.filter(f => f !== name);
            else STATE.expandedFolders.push(name);
            render();
        };

        window.deleteProject = (name) => {
            if (confirm(`'${name}' projesini sil?`)) { STATE.savedLocations = STATE.savedLocations.filter(l => l.folderName !== name); localStorage.setItem('gps_locations_v4', JSON.stringify(STATE.savedLocations)); render(); }
        };

        window.deletePoint = (id) => {
            if (confirm("Noktayı sil?")) { STATE.savedLocations = STATE.savedLocations.filter(l => l.id !== id); localStorage.setItem('gps_locations_v4', JSON.stringify(STATE.savedLocations)); render(); }
        };

        window.toggleExportFolder = (name) => {
            if (STATE.selectedExportFolders.includes(name)) STATE.selectedExportFolders = STATE.selectedExportFolders.filter(f => f !== name);
            else STATE.selectedExportFolders.push(name);
            render();
        };

        async function injectScript(url) {
            return new Promise(res => {
                if (document.querySelector(`script[src="${url}"]`)) return res();
                const s = document.createElement('script'); s.src = url; s.onload = res; document.head.appendChild(s);
            });
        }

        async function exportData(format) {
            if (STATE.selectedExportFolders.length === 0) return alert("Proje seçin.");
            const targets = STATE.savedLocations.filter(l => STATE.selectedExportFolders.includes(l.folderName));
            const ts = new Date().getTime();
            if (format === 'kml') {
                const kml = `<?xml version="1.0" encoding="UTF-8"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document>${targets.map(l => `<Placemark><name>${l.name}</name><Point><coordinates>${l.lng},${l.lat},0</coordinates></Point></Placemark>`).join('')}</Document></kml>`;
                const blob = new Blob([kml], { type: 'text/xml' }); const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `ACB_Veri_${ts}.kml`; a.click();
            } else if (format === 'xlsx') {
                await injectScript('https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js');
                const rows = targets.map(l => ({ "Proje": l.folderName, "Nokta": l.name, "Enlem": l.lat, "Boylam": l.lng, "Yükseklik": l.altitude }));
                const ws = XLSX.utils.json_to_sheet(rows); const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Veriler"); XLSX.writeFile(wb, `ACB_Excel_${ts}.xlsx`);
            } else if (format === 'zip') {
                const photos = targets.filter(l => l.photo); if (photos.length === 0) return alert("Fotoğraf yok.");
                await injectScript('https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js');
                const zip = new JSZip(); photos.forEach(l => zip.file(`${l.folderName}_${l.name}.jpg`, l.photo.split(',')[1], { base64: true }));
                const content = await zip.generateAsync({ type: "blob" });
                const url = URL.createObjectURL(content); const a = document.createElement('a'); a.href = url; a.download = `ACB_Foto_${ts}.zip`; a.click();
            }
        }

        // Start
        render();
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
